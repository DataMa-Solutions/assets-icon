name: Build Release Assets

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Build icons
        run: npm run build:all

      - name: Run tests
        run: npm test

      - name: Verify dist directory
        run: |
          echo "📁 Contents of dist directory:"
          ls -la dist/
          echo ""
          echo "📊 Checking for required files..."
          test -f dist/index-simple.js && echo "✅ index-simple.js found" || echo "❌ index-simple.js missing"
          test -f dist/icons.js && echo "✅ icons.js found" || echo "❌ icons.js missing"
          test -f dist/icons.json && echo "✅ icons.json found" || echo "❌ icons.json missing"

      - name: Create release files
        run: |
          # Create release directory
          mkdir -p release-assets
          
          # Copy the essential JavaScript files for direct download
          cp dist/index-simple.js release-assets/datama-icons-simple.js
          cp dist/icons.js release-assets/datama-icons-data.js
          cp dist/icons.json release-assets/datama-icons-data.json
          
          # Create complete archive
          mkdir -p complete-package
          cp package.json complete-package/
          cp README.md complete-package/
          cp -r dist complete-package/
          cp -r icons complete-package/
          
          # Create archives
          cd complete-package
          zip -r "../release-assets/datama-icons-${{ steps.version.outputs.version }}-complete.zip" .
          cd ..
          
          echo ""
          echo "📦 Created release assets:"
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: DataMa Icons ${{ steps.version.outputs.version }}
          body: |
            ## 🎨 DataMa Icons ${{ steps.version.outputs.version }}
            
            Bibliothèque d'icônes DataMa avec **118 icônes** organisées en **7 catégories**.
            
            ### 📥 Téléchargement direct (pour extensions JS)
            
            **Fichier principal recommandé :**
            - `datama-icons-simple.js` - API JavaScript vanilla (3.6KB)
            
            **Autres fichiers :**
            - `datama-icons-data.js` - Données des icônes (ES modules)
            - `datama-icons-data.json` - Données des icônes (JSON)
            
            ### 🚀 Utilisation rapide
            
            ```html
            <!-- Inclure dans votre extension -->
            <script src="datama-icons-simple.js"></script>
            <script>
              // Remplacer automatiquement tous les data-datama
              DataMaIcons.replace();
              
              // Ou utiliser l'API
              const iconSvg = DataMaIcons.toSvg('check-svg', { size: 24, fill: 'blue' });
              document.getElementById('myIcon').innerHTML = iconSvg;
            </script>
            ```
            
            ### 📦 URLs de téléchargement direct
            
            Vous pouvez télécharger les fichiers directement depuis :
            ```
            https://github.com/DataMa-Solutions/assets-icon/releases/download/${{ steps.version.outputs.version }}/datama-icons-simple.js
            ```
            
            ### 🎯 Categories disponibles
            
            - 💼 **Actions** - Contrôles d'interface utilisateur
            - 📊 **Data** - Visualisation de données  
            - 🎨 **Illustrations** - Illustrations complexes
            - 💡 **Light** - Icônes simples et cohérentes
            - 🏢 **Logos** - Logos de marques
            - 🧭 **Navigation** - Icônes de navigation
            - 🎛️ **UI** - Éléments d'interface
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Call the deploy workflow only if we have the required secrets
  deploy:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/deploy-release.yml
    with:
      version: ${{ needs.build.outputs.version }}
      tag: ${{ needs.build.outputs.tag }}
    secrets:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      GCS_CDN_URL: ${{ secrets.GCS_CDN_URL }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }} 