name: Build Release Assets

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Build icons
        run: npm run build:all

      - name: Run tests
        run: npm test

      - name: Verify dist directory
        run: |
          echo "ğŸ“ Contents of dist directory:"
          ls -la dist/
          echo ""
          echo "ğŸ“Š Checking for required files..."
          test -f dist/index-simple.js && echo "âœ… index-simple.js found" || echo "âŒ index-simple.js missing"
          test -f dist/icons.js && echo "âœ… icons.js found" || echo "âŒ icons.js missing"
          test -f dist/icons.json && echo "âœ… icons.json found" || echo "âŒ icons.json missing"

      - name: Create release files
        run: |
          # Create release directory
          mkdir -p release-assets
          
          # Copy the essential JavaScript files for direct download
          cp dist/index-simple.js release-assets/datama-icons-simple.js
          cp dist/icons.js release-assets/datama-icons-data.js
          cp dist/icons.json release-assets/datama-icons-data.json
          
          # Create complete archive
          mkdir -p complete-package
          cp package.json complete-package/
          cp README.md complete-package/
          cp -r dist complete-package/
          cp -r icons complete-package/
          
          # Create archives
          cd complete-package
          zip -r "../release-assets/datama-icons-${{ steps.version.outputs.version }}-complete.zip" .
          cd ..
          
          echo ""
          echo "ğŸ“¦ Created release assets:"
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: DataMa Icons ${{ steps.version.outputs.version }}
          body: |
            ## ğŸ¨ DataMa Icons ${{ steps.version.outputs.version }}
            
            BibliothÃ¨que d'icÃ´nes DataMa avec **118 icÃ´nes** organisÃ©es en **7 catÃ©gories**.
            
            ### ğŸ“¥ TÃ©lÃ©chargement direct (pour extensions JS)
            
            **Fichier principal recommandÃ© :**
            - `datama-icons-simple.js` - API JavaScript vanilla (3.6KB)
            
            **Autres fichiers :**
            - `datama-icons-data.js` - DonnÃ©es des icÃ´nes (ES modules)
            - `datama-icons-data.json` - DonnÃ©es des icÃ´nes (JSON)
            
            ### ğŸš€ Utilisation rapide
            
            ```html
            <!-- Inclure dans votre extension -->
            <script src="datama-icons-simple.js"></script>
            <script>
              // Remplacer automatiquement tous les data-datama
              DataMaIcons.replace();
              
              // Ou utiliser l'API
              const iconSvg = DataMaIcons.toSvg('check-svg', { size: 24, fill: 'blue' });
              document.getElementById('myIcon').innerHTML = iconSvg;
            </script>
            ```
            
            ### ğŸ“¦ URLs de tÃ©lÃ©chargement direct
            
            Vous pouvez tÃ©lÃ©charger les fichiers directement depuis :
            ```
            https://github.com/DataMa-Solutions/assets-icon/releases/download/${{ steps.version.outputs.version }}/datama-icons-simple.js
            ```
            
            ### ğŸ¯ Categories disponibles
            
            - ğŸ’¼ **Actions** - ContrÃ´les d'interface utilisateur
            - ğŸ“Š **Data** - Visualisation de donnÃ©es  
            - ğŸ¨ **Illustrations** - Illustrations complexes
            - ğŸ’¡ **Light** - IcÃ´nes simples et cohÃ©rentes
            - ğŸ¢ **Logos** - Logos de marques
            - ğŸ§­ **Navigation** - IcÃ´nes de navigation
            - ğŸ›ï¸ **UI** - Ã‰lÃ©ments d'interface
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Call the deploy workflow only if we have the required secrets
  deploy:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/deploy-release.yml
    with:
      version: ${{ needs.build.outputs.version }}
      tag: ${{ needs.build.outputs.tag }}
    secrets:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      GCS_CDN_URL: ${{ secrets.GCS_CDN_URL }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }} 